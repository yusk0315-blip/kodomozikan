<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>子どもとの関わり 残り回数・時間メーター</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(52,211,153,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 80px}
    header{display:flex;flex-direction:column;gap:8px;margin:6px 0 14px}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;line-height:1.45}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .card h2{font-size:14px;margin:0 0 10px;color:#cbd5e1}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:820px){.controls{grid-template-columns:1fr}}
    label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    input{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    input:focus{border-color:rgba(96,165,250,.6); box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .grid{
      display:grid;
      grid-template-columns:1.1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .item{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:rgba(15,23,42,.55);
    }
    .itemTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .name{font-size:16px;font-weight:700}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:#cbd5e1;
      background:rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .badge.good{border-color:rgba(52,211,153,.35); color:#a7f3d0}
    .badge.warn{border-color:rgba(251,191,36,.35); color:#fde68a}
    .badge.bad{border-color:rgba(251,113,133,.35); color:#fecdd3}
    .meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
    .meta label{font-size:11px}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1;
      min-width:170px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
    }
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:800;margin-top:2px}
    .barWrap{margin-top:10px}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--line);
    }
    .bar > div{height:100%;width:0%;}
    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.45}
    .summary{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:900px){.summary{grid-template-columns:1fr}}
    .sumBig{
      font-size:24px;font-weight:900;letter-spacing:.2px
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
    }
    button:active{transform:translateY(1px)}
    .btnPrimary{border-color:rgba(96,165,250,.35); background:rgba(96,165,250,.14)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;
      font-size:13px;color:#cbd5e1;
      box-shadow:0 16px 30px rgba(0,0,0,.35);
      display:none;
      max-width:min(92vw,820px);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>子どもとの関わり 残り回数・時間メーター</h1>
      <div class="sub">
        今の年齢から「いつまでできそうか（卒業年齢）」と「頻度・平均時間」を入れると、<b>残り回数</b>と<b>残り時間</b>を自動計算します。<br/>
        ※あくまで目安。家庭のペースに合わせて調整してOK。
      </div>
    </header>

    <section class="card">
      <h2>基本設定</h2>
      <div class="controls">
        <label>子どもの年齢（歳）
          <input id="ageYears" type="number" min="0" step="1" value="3" />
        </label>
        <label>子どもの年齢（ヶ月）
          <input id="ageMonths" type="number" min="0" max="11" step="1" value="0" />
        </label>
        <label>計算の週数/年（通常52）
          <input id="weeksPerYear" type="number" min="48" max="54" step="1" value="52" />
        </label>
      </div>

      <div class="summary">
        <div class="card" style="margin:0">
          <h2>合計（すべての関わり）</h2>
          <div class="sumBig" id="sumHours">—</div>
          <div class="sub" id="sumCounts">—</div>
          <div class="hint">この合計は「残り時間の総量」。忙しい日に指標として使える。</div>
        </div>

        <div class="card" style="margin:0">
          <h2>使い方のコツ</h2>
          <div class="sub" style="line-height:1.55">
            ・「卒業年齢」は迷ったら<b>少し短め</b>に置く（危機感が出る）<br/>
            ・頻度は<b>理想じゃなく現実</b>を入れる（続く）<br/>
            ・数字が減る＝悲しい ではなく、<b>今日を大事にできた証拠</b><br/>
          </div>
          <div class="btns">
            <button class="btnPrimary" id="btnShare">結果を共有（文章コピー）</button>
            <button id="btnReset">初期値に戻す</button>
          </div>
        </div>
      </div>
    </section>

    <div class="grid" id="items"></div>

    <div class="hint" style="margin-top:14px">
      ※保存：入力はこの端末のブラウザに自動保存されます（localStorage）。<br/>
      ※「卒業年齢」より現在年齢が上の場合は、残りは0として表示します。
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---- デフォルト項目（自由に増減OK）----
    const DEFAULT_ITEMS = [
      { key:"bath",  name:"一緒にお風呂",    endAge:10, perWeek:3, minutes:20 },
      { key:"hand",  name:"手をつなぐ",      endAge:12, perWeek:5, minutes:10 },
      { key:"hug",   name:"抱っこ",          endAge:6,  perWeek:4, minutes:5  },
      { key:"sleep", name:"一緒に寝る",      endAge:9,  perWeek:6, minutes:25 },
      { key:"play",  name:"遊ぶ",            endAge:13, perWeek:5, minutes:30 },
      { key:"out",   name:"出かける",        endAge:15, perWeek:1, minutes:180 }
    ];

    const LS_KEY = "kid_time_meter_v1";

    const el = (id)=>document.getElementById(id);

    function clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }
    function fmtInt(n){ return Math.round(n).toLocaleString("ja-JP"); }
    function fmt1(n){ return (Math.round(n*10)/10).toLocaleString("ja-JP"); }

    function showToast(msg){
      const t = el("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(()=>{ t.style.display="none"; }, 2200);
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function saveState(state){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){}
    }

    function getAgeYears(){
      const y = Number(el("ageYears").value||0);
      const m = Number(el("ageMonths").value||0);
      return y + (clamp(m,0,11)/12);
    }

    function badgeByRatio(r){
      // r=remainingYears / totalYears(=endAge-currentAge? not used) -> we'll use remainingYears itself
      if(r <= 1) return ["bad","ラスト1年圏内"];
      if(r <= 3) return ["warn","残り少なめ"];
      return ["good","まだ間に合う"];
    }

    function calcItem(currentAge, weeksPerYear, item){
      const endAge = Number(item.endAge||0);
      const perWeek = Number(item.perWeek||0);
      const minutes = Number(item.minutes||0);

      const remainingYears = Math.max(0, endAge - currentAge);
      const remainingWeeks = remainingYears * weeksPerYear;

      const remainingCount = Math.max(0, remainingWeeks * perWeek);
      const remainingMinutes = remainingCount * minutes;
      const remainingHours = remainingMinutes / 60;

      // progress bar: 0..100 based on remainingYears vs 0..endAge (rough)
      const ratio = endAge > 0 ? (remainingYears / endAge) : 0;
      const pct = clamp(ratio*100, 0, 100);

      return {remainingYears, remainingCount, remainingHours, pct};
    }

    function buildUI(state){
      const wrap = el("items");
      wrap.innerHTML = "";

      state.items.forEach((item, idx)=>{
        const div = document.createElement("section");
        div.className = "item";

        div.innerHTML = `
          <div class="itemTop">
            <div class="name">${item.name}</div>
            <div class="badge" id="badge-${item.key}">—</div>
          </div>

          <div class="barWrap">
            <div class="bar"><div id="bar-${item.key}"></div></div>
          </div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="t">残り回数（目安）</div>
              <div class="v" id="count-${item.key}">—</div>
            </div>
            <div class="kpi">
              <div class="t">残り時間（目安）</div>
              <div class="v" id="hours-${item.key}">—</div>
            </div>
          </div>

          <div class="meta">
            <label>卒業年齢（歳）
              <input type="number" min="0" step="1" value="${item.endAge}" data-k="${item.key}" data-f="endAge" />
            </label>
            <label>頻度（週あたり回）
              <input type="number" min="0" step="0.5" value="${item.perWeek}" data-k="${item.key}" data-f="perWeek" />
            </label>
            <label>平均（1回あたり分）
              <input type="number" min="0" step="1" value="${item.minutes}" data-k="${item.key}" data-f="minutes" />
            </label>
          </div>

          <div class="hint">
            「卒業年齢」は“その行動が自然に減りそうな年齢”の目安。家庭に合わせて変えてOK。
          </div>
        `;

        wrap.appendChild(div);
      });

      wrap.addEventListener("input", (ev)=>{
        const t = ev.target;
        if(!(t instanceof HTMLInputElement)) return;
        const key = t.dataset.k;
        const field = t.dataset.f;
        if(!key || !field) return;

        const item = state.items.find(x=>x.key===key);
        if(!item) return;

        item[field] = Number(t.value||0);
        saveState(state);
        render(state);
      }, {passive:true});
    }

    function render(state){
      const currentAge = getAgeYears();
      const weeksPerYear = Number(el("weeksPerYear").value||52);

      let sumHours = 0;
      let sumCount = 0;

      state.items.forEach(item=>{
        const r = calcItem(currentAge, weeksPerYear, item);
        sumHours += r.remainingHours;
        sumCount += r.remainingCount;

        // badge
        const [cls, label] = badgeByRatio(r.remainingYears);
        const b = el(`badge-${item.key}`);
        if(b){
          b.className = `badge ${cls}`;
          b.textContent = label + `（残り約${fmt1(r.remainingYears)}年）`;
        }

        // numbers
        const c = el(`count-${item.key}`);
        const h = el(`hours-${item.key}`);
        if(c) c.textContent = `${fmtInt(r.remainingCount)} 回`;
        if(h) h.textContent = `${fmtInt(r.remainingHours)} 時間`;

        // bar
        const bar = el(`bar-${item.key}`);
        if(bar){
          bar.style.width = `${r.pct}%`;
          // 色は指定しすぎず、濃淡で（グラデ）
          bar.style.background = `linear-gradient(90deg, rgba(96,165,250,.9), rgba(52,211,153,.9))`;
        }
      });

      el("sumHours").textContent = `${fmtInt(sumHours)} 時間（目安）`;
      el("sumCounts").textContent = `合計 残り ${fmtInt(sumCount)} 回（目安）`;

      // save base fields too
      state.base = {
        ageYears: Number(el("ageYears").value||0),
        ageMonths: Number(el("ageMonths").value||0),
        weeksPerYear: Number(el("weeksPerYear").value||52)
      };
      saveState(state);
    }

    function makeShareText(state){
      const currentAge = getAgeYears();
      const weeksPerYear = Number(el("weeksPerYear").value||52);

      const lines = [];
      lines.push("【子どもとの関わり 残りメーター】");
      lines.push(`現在年齢：${fmt1(currentAge)}歳（週/年=${weeksPerYear}）`);

      let sumH=0, sumC=0;
      state.items.forEach(item=>{
        const r = calcItem(currentAge, weeksPerYear, item);
        sumH += r.remainingHours; sumC += r.remainingCount;
        lines.push(`- ${item.name}：残り${fmtInt(r.remainingCount)}回 / ${fmtInt(r.remainingHours)}時間（卒業${item.endAge}歳）`);
      });

      lines.push(`合計：残り${fmtInt(sumC)}回 / ${fmtInt(sumH)}時間（目安）`);
      lines.push("");
      lines.push("今日1回増やす。未来の後悔を1つ減らす。");

      return lines.join("\n");
    }

    function init(){
      const saved = loadState();

      const state = saved && saved.items ? saved : { items: structuredClone(DEFAULT_ITEMS), base:{} };

      // restore base fields
      if(state.base){
        if(typeof state.base.ageYears === "number") el("ageYears").value = state.base.ageYears;
        if(typeof state.base.ageMonths === "number") el("ageMonths").value = state.base.ageMonths;
        if(typeof state.base.weeksPerYear === "number") el("weeksPerYear").value = state.base.weeksPerYear;
      }

      buildUI(state);
      render(state);

      ["ageYears","ageMonths","weeksPerYear"].forEach(id=>{
        el(id).addEventListener("input", ()=>{
          render(state);
        }, {passive:true});
      });

      el("btnReset").addEventListener("click", ()=>{
        const fresh = { items: structuredClone(DEFAULT_ITEMS), base:{ ageYears:3, ageMonths:0, weeksPerYear:52 } };
        saveState(fresh);
        location.reload();
      });

      el("btnShare").addEventListener("click", async ()=>{
        const text = makeShareText(state);
        try{
          await navigator.clipboard.writeText(text);
          showToast("コピーしました！ note / X に貼れます");
        }catch(e){
          // fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          showToast("コピーしました（互換モード）");
        }
      });
    }

    init();
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
